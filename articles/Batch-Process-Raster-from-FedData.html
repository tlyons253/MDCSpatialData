<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Batch Processing FedData • MDCSpatialData</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Batch Processing FedData">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MDCSpatialData</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Batch-Process-Raster-from-FedData.html">Batch Processing FedData</a></li>
    <li><a class="dropdown-item" href="../articles/Missouri-Spatial-Data.html">Accessing spatial data for Missouri</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tlyons253/MDCSpatialData/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Batch Processing FedData</h1>
            
            <h4 data-toc-skip class="date">Last update: 2025-01-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tlyons253/MDCSpatialData/blob/master/vignettes/Batch-Process-Raster-from-FedData.Rmd" class="external-link"><code>vignettes/Batch-Process-Raster-from-FedData.Rmd</code></a></small>
      <div class="d-none name"><code>Batch-Process-Raster-from-FedData.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="batch-processing">Batch Processing<a class="anchor" aria-label="anchor" href="#batch-processing"></a>
</h2>
<p>This is an example for batch processing multiple years of NLCD data.
It requires creating a folder with two subfolders where the tif’s can be
stored. The NCLD data is unprojected when it’s downloaded, so you will
need to project it to your preferred coordinate system. It’s a
multi-step process.</p>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">'C:/Users/Lyonst/Desktop/NLCD/unproj'</span>,</span>
<span>           recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="co"># create a folder and first subfolder for storing unprojected tif's. Use relative paths if you know how to and/or have an R project set up. </span></span>
<span></span>
<span><span class="va">my.path</span><span class="op">&lt;-</span><span class="st">'C:/Users/Lyonst/Desktop/NLCD'</span>  <span class="co"># save the parent folder path as an object, not just the lowest folder</span></span>
<span></span>
<span><span class="va">years_to_dl</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2010</span>,<span class="fl">2015</span>,<span class="fl">2020</span><span class="op">)</span> <span class="co"># object referencing the years of NCLD you'd like to download</span></span>
<span><span class="co"># Older NLCD data was only released about every 3 years, but now USGS is going back and using different processing to generate/estimate/interpolate annual data sets. Upshot is, you now have annual data if you think you need it</span></span></code></pre></div>
<p>Now use the vector of years to iteratively download the data from
[FedData].</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pass the vector of years to the map function to iteratively call FedData::get_nlcd_annual</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">years_to_dl</span>,</span>
<span>           <span class="op">~</span><span class="fu">FedData</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_nlcd_annual.html" class="external-link">get_nlcd_annual</a></span><span class="op">(</span>template<span class="op">=</span><span class="fu">MDCSpatialData</span><span class="fu">::</span><span class="va"><a href="../reference/state.mo.html">state.mo</a></span>,</span>
<span>                                     label<span class="op">=</span><span class="st">'MO_noproj'</span>,</span>
<span>                                     year<span class="op">=</span><span class="va">.x</span>,</span>
<span>                                     product<span class="op">=</span><span class="st">'LndCov'</span>,</span>
<span>                                     extraction.dir<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my.path</span>,<span class="st">'/unproj'</span><span class="op">)</span></span>
<span>                                     <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This writes 3 tif files with “MO_noproj” in the file name. The files
are 2010, 2015, and 2020 annual NLCD landcover. The way FedData works is
it creates a rectangle of min/max X and Y for the template and crops to
that. So our rasters contain a good chunk of KS, IL and a little bit of
IA and AR. We’ll clean that up in the next step</p>
</div>
<div class="section level3">
<h3 id="reproject">Reproject<a class="anchor" aria-label="anchor" href="#reproject"></a>
</h3>
<p>To reproject, you’ll need to create an object of the full file paths
of all the unprojected files, setup another subfolder to hold the
reprojected tif’s,</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List the tif files in the folder</span></span>
<span></span>
<span><span class="va">unproj.files</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my.path</span>,<span class="st">'/unproj'</span><span class="op">)</span>,</span>
<span>                         pattern<span class="op">=</span><span class="st">'.tif$'</span>, <span class="co"># regex for files that end in .tif</span></span>
<span>                         full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="co">#create a vector of new names</span></span>
<span></span>
<span><span class="va">rast.names</span><span class="op">&lt;-</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">unproj.files</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'NLCD_Y'</span>,<span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">.x</span>,pattern<span class="op">=</span><span class="st">'20\\d{2}'</span><span class="op">)</span>,<span class="st">'_proj'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#tif file names will now look like 'NLCD_Y2010_proj.tif' after reprojections</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">'C:/Users/Lyonst/Desktop/NLCD/prj'</span><span class="op">)</span> <span class="co"># Create a directory to hold the projected files</span></span>
<span></span>
<span></span>
<span> <span class="co"># write a function to take the list of unprojected files and names we'd like to have for the new projected files, and reproject, crop/mask and write them  </span></span>
<span></span>
<span><span class="va">rast.fxn</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">X</span>,<span class="va">Y</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>,<span class="st">'EPSG:26915'</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">Z</span><span class="co">#NAD83 UTM15N code</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">Z</span>,<span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">MDCSpatialData</span><span class="fu">::</span><span class="va"><a href="../reference/state.mo.html">state.mo</a></span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">W</span> <span class="co"># assign raster cells outside the state boundary an NA value</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">W</span>,</span>
<span>                   filename<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my.path</span>,<span class="st">'/prj/'</span>,<span class="va">rast.names</span>,<span class="st">'.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># use future to run these in parallel</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu">plan</span><span class="op">(</span><span class="st">"multisession"</span>,workers<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">furrr</span><span class="fu">::</span><span class="fu">future_map2</span><span class="op">(</span><span class="va">unproj.files</span>,<span class="va">rast.names</span>,<span class="op">~</span><span class="fu">rast.fxn</span><span class="op">(</span><span class="va">.x</span>,<span class="va">.y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># this takes approximately 10 minutes for 3 NLCD rasters for the state of MO</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu">plan</span><span class="op">(</span><span class="st">'sequential'</span><span class="op">)</span> <span class="co"># reset</span></span></code></pre></div>
<p>You can stop here and delete all the entire
<strong>…/unproj/</strong> folder if you like. Alternatively, you can
combine all the annual raster files into a multiband raster object. The
advantage is you only have to read in one object to get all your
rasters. The downside is it’s probably more efficient to process the
data by creating lists of files and passing it to [purrr::map] as we
have done above. Still…if you want to try…</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my.rast</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my.path</span>,<span class="st">'/prj'</span><span class="op">)</span>,</span>
<span>                         pattern<span class="op">=</span><span class="st">'.tif$'</span>, <span class="co"># regex for files that end in .tif</span></span>
<span>                         full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># read in multiple rasters</span></span>
<span></span>
<span><span class="va">tmp</span><span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">my.rast</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">tmp</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my.path</span>,<span class="st">'/prj/all_nlcd.tif'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>There are additional functions in terra that help you process the
bands together or separately. Note that the multiband raster only works
if all the bands have the exact same spatial extent. So if you think you
might want to crop or clip different years in different ways, it’s best
to keep the individual years as separate files and objects, even if it
is less efficient with memory.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tim Lyons.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
